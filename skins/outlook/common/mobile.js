var rcs_mobile=new function(){this.filterActive=false;this.searchActive=false;this.panDirection=false;this.actionRowOpen=false;this.clearSelectionOnPopupHide=false;this.panRefreshAllowed=false;this.contentElements=false;this.debug=false;this.runOnReady=function(){if(typeof skinRunOnReadyBefore=="function"){skinRunOnReadyBefore()}this.setupGestureMessageView();this.setupGestureRefresh();bw.mobile=false;bw.iphone=false;bw.ipad=false;bw.touch=false;$("body").removeClass("noscroll");if(typeof rcs_disable_login_logo=="undefined"||rcs_disable_login_logo!=true){if($("#login-form").length){$("html").addClass("login-page");$("#bottomline").append("<a href='http://roundcubeskins.net' target='_blank' class='support-link'>RoundcubeSkins.net</a>")}}rcs_mobile.contentElements=$("#main-menu, #mainscreen, #planner_controls_container, #planner_items, #filter_bar, #notes");this.createPopupBoxes();this.fixButtons();$("#skin-options a").on("click",function(a){rcs_mobile.popupHide(a)});$("#attachment-list .delete").html("");if($("#messagelistcontainer").length){$("#messagelistcontainer").before("<div id='current-folder'><span></span></div>");rcs_mobile.updateCurrentFolder()}$("#mailboxlist li a").click(function(a){rcs_mobile.updateCurrentFolder();rcs_mobile.popupHide(a)});if($("#rcmlistfilter").length){this.filterActive=$("#rcmlistfilter").val()!="ALL";this.updateFunnel()}if($("#messagelistcontainer").length){rcs_mobile.setMailTimeout()}if($("#messagecontent .rightcol").length){$("#messagecontent .leftcol").after($("#messagecontent .rightcol"))}rcmail.addEventListener("aftermove",function(a){rcs_mobile.addFolderSelectorHeader()});rcmail.addEventListener("aftercopy",function(a){rcs_mobile.addFolderSelectorHeader()});if($(".btn-sectionslist").length){setTimeout(function(){rcmail.section_select(new settingsLoader("general"))},500)}if($("#compose-contacts .boxfooter a").length){$("#compose-contacts .boxfooter a").on("click",function(a){rcs_mobile.popupHide(a)})}if($("#header h5 select.deco").length){$("#header h5 select.deco").on("click",function(a){a.stopPropagation()})}if($(".remotehint")){setTimeout(function(){$(".remotehint").fadeOut()},3000)}$(".calendar-page #sectionslist .boxtitle.ui-widget-header a").on("click",function(){rcs_mobile.showCalendarOld("calendar")});if($("#groupoptionslink span.inner").length){$("#groupoptionslink span.inner").html("")}if(typeof skinRunOnReadyAfter=="function"){skinRunOnReadyAfter()}};this.addFolderSelectorHeader=function(){if(!$("#folder-selector h5").length){rcs_mobile.addPopupTitle($("#folder-selector"),rcs_label_folders);rcs_mobile.addPopupCloseButtonBar($("#folder-selector"));$("#folder-selector").on("mouseup",function(a){rcs_mobile.popupHide(a)})}};this.fixButtons=function(){$("a.firstpage, a.prevpage,a.nextpage, a.lastpage,a.listbutton.add span.inner,a.listbutton.delete span.inner,a.listbutton.removegroup span.inner").text("")};this.createPopupBoxes=function(){this.makePopup($("#header"),false);this.makePopup($("#mailview-left"),false);this.makePopup($("#quicksearchbar"),false);this.makePopup($("#mailtoolbar"),false);this.makePopup($("#messagetoolbar"));this.makePopup($("#settings-sections"),false);this.makePopup($("#addressbooktoolbar"));this.makePopup($("#composeview-left"),false);this.makePopup($("#groupoptions"),false);this.makePopup($("#mailboxmenu"),false);this.makePopup($("#filtersetmenu-menu"));this.makePopup($("#filtermenu-menu"));$("#filtersetmenulink").attr("onclick","rcs_mobile.popup(event, 'filtersetmenu-menu')");$("#filtermenulink").attr("onclick","rcs_mobile.popup(event, 'filtermenu-menu')");$("#filtersetslistbox a.add").text($("#filtersetslistbox a.add").attr("title")).appendTo("#filtersetmenu-menu");$("#filterslistbox a.add").text($("#filterslistbox a.add").attr("title")).appendTo("#filtermenu-menu");$("#mailboxmenulink").text($("#mailboxmenulink").attr("title"));$("#quicksearchbar").appendTo("body");$("#mailview-left").appendTo("body");$("#messagetoolbar").appendTo("body");this.addPopupTitle($("#mailboxmenu"),$("#mailboxmenulink").attr("title"));this.addPopupTitle($("#markmessagemenu"),$("#markmessagemenulink").text());this.addPopupTitle($("#messagemenu"),$("#messagemenulink").text());this.addPopupTitle($("#replyallmenu"),$(".button.reply").text());this.addPopupTitle($("#forwardmenu"),$(".button.forward").text());this.addPopupTitle($("#mailview-left"),rcs_label_folders);this.addPopupTitle($("#header"),$("#topline .username").html());this.addPopupTitle($("#quicksearchbar"),rcs_label_search);this.addPopupTitle($("#attachmentmenu"),rcs_label_attachment);this.addPopupTitle($("#settings-sections"),rcs_label_section);this.addPopupTitle($("#mailtoolbar"),rcs_label_options);this.addPopupTitle($("#composeview-left"),$("#composeview-left h2.boxtitle").text());this.addPopupTitle($("#responsesmenu"),$("#responsesmenu li.separator:first label").text());this.addPopupTitle($("#addressbooktoolbar"),rcs_label_options);this.addPopupTitle($("#groupoptions"),$("#aria-label-groupoptions").text());if($("a#spellmenulink").length){this.addPopupTitle($("#spellmenu"),$("a#spellmenulink").text())}else{this.addPopupTitle($("#spellmenu"),$("#mailtoolbar a.spellcheck").attr("title"))}if($(".calendar-page").length){this.addPopupTitle($("#messagetoolbar"),rcs_label_options)}else{this.addPopupTitle($("#messagetoolbar"),$("#taskbar .button-mail .button-inner").text())}$(".popupmenu").addClass("popup-box");if($("#groupoptionslink").length){$("#groupoptionslink").attr("onclick","rcs_mobile.popup(event, 'groupoptions')")}if($("#mailboxmenulink").length){$("#mailboxmenulink").attr("onclick","rcs_mobile.popup(event, 'mailboxmenu')")}$(".popup-box a").each(function(){var d=$(this);var c=d.attr("onclick");if(typeof c!="undefined"&&(c.indexOf("toggle_popup")!=-1||c.indexOf("command('move'")!=-1||c.indexOf("command('copy'")!=-1)){d.on("click",function(e){rcs_mobile.popupDisappear(e);setTimeout(function(){$(".popupmenu").addClass("popup-box");if(!$("#spellmenu").hasClass("processed")){$("#spellmenu").addClass("processed");$("#spellmenu a").on("click",function(f){rcs_mobile.popupHide(f)})}},0)})}});$(".button-skin-options").on("click",function(c){rcs_mobile.popupDisappear(c)});this.addPopupCloseButtonBar($(".popup-box"));if($(".login-page #header").length){$("#login-form").after("<a id='login-menu-button' href='javascript:void(0)' onclick='rcs_mobile.popup(event, \"header\")'></a>")}if($("#composebody").length){var b=$("#mailtoolbar").length?"mailtoolbar":"messagetoolbar";$("#main-menu").append("<a id='button-toolbar' href='javascript:void(0)' onclick='rcs_mobile.popup(event, \""+b+"\")'><span></span></a>");$("#popup-compose-settings").append($("#composeheaders .formlinks").html());$("#composeheaders .formlinks").html("");$("#popup-compose-settings a").each(function(){$(this).attr("onclick",$(this).attr("onclick").replace("UI.show_header_row","rcs_mobile.toggleCC"))});$("#popup-compose-settings").append($(".compose-headers a.iconlink.edit"));$("#popup-compose-settings").append($("#composeoptions"))}var a=false;if($("#rcmlistfilter").length){a="#rcmlistfilter"}else{if($("#searchfilter").length){a="#searchfilter"}}if(a){$(a+" option").each(function(){$("#popup-filter").append("<a href='javascript:void(0)' onclick='rcs_mobile.applyFilter(event, \""+$(this).val()+"\")'>"+$(this).text()+"</a>")})}if($("#quicksearchbar").length){$("#quicksearchbar form").after($("#searchmenu ul"));$("#quicksearchbar ul").after("<a class='search-apply' href='javascript:void(0)' onclick='rcs_mobile.applySearch(event, this)'>"+rcs_label_search+"</a><a class='search-reset' href='javascript:void(0)' onclick='rcs_mobile.resetSearch(event, this)'>"+$("#searchreset").attr("title")+"</a>");$("#quicksearchbar form").attr("onsubmit","rcs_mobile.applySearch(event); return false;")}$(".popupmenu").addClass("click-close");$(".popup-box.click-close").on("click",function(c){rcs_mobile.popupHide(c)});$(".popup-box select, .popup-box input[type='checkbox']").on("click",function(c){c.stopPropagation()});if($("#summarytable").length){$("#summarytable").html($("#summarytable").html().replace(/&nbsp;/g,""))}};this.makePopup=function(c,a,b){if(!c.length){return}a=typeof a=="undefined"||a?true:false;c.removeClass().addClass("popup-box");c.removeClass("toolbar");if(a){c.addClass("click-close")}if(typeof b!="undefined"){c.attr("id",b)}c.appendTo("body")};this.addPopupCloseButtonBar=function(a){if(!a.length){return}a.prepend("<div class='popup-close'><a href='javascript:void(0)' onclick='rcs_mobile.popupHide(event, true, this)'></a></div>")};this.addPopupTitle=function(a,c){if(!a.length){return}var b="<h5>"+c+"</h5>";if(a.find(".popup-close").length){a.find(".popup-close").after(b)}else{a.prepend(b)}};this.popup=function(b,c,a){if($("#"+c+":visible").length){this.popupHide(b,true);return}if(c=="messagetoolbar"){if($("#markmessagemenu-menu li a:first").attr("aria-disabled")=="true"){$("#markmessagemenulink, #messagemenulink").addClass("disabled")}else{$("#markmessagemenulink, #messagemenulink").removeClass("disabled")}}if($(".popup-box:visible").length){$(".popup-box").fadeOut();$("#"+c).fadeIn();return}$(".popup-box").hide();setTimeout(function(){$("#"+c).show();$("body").addClass("popup-visible");var d=105;var e=rcs_mobile.contentElements.outerWidth();rcs_mobile.contentElements.addClass("moved-container").animate({left:e-d,right:(e-d)*-1},300,"swing",a)},0)};this.popupHide=function(d,a,c){a=typeof a!=="undefined"?a:false;d.stopPropagation();var b=typeof c!=="undefined"?$(c).parents(".popup-box"):false;if($(".popup-box:visible").length>1&&b){b.hide();return}$("body").removeClass("popup-visible");if(a){rcs_mobile.contentElements.removeClass("moved-container").animate({left:0,right:0},300,"swing",function(){$(".popup-box").hide()})}else{rcs_mobile.contentElements.removeClass("moved-container").css("left",0).css("right",0);$(".popup-box").hide()}};this.popupDisappear=function(a){this.log("popupDisappear");$(a.target).parents(".popup-box").hide();a.stopPropagation()};this.setMailTimeout=function(){rcs_mobile.mailTimer=setTimeout("rcs_mobile.mailTimout()",1000)};this.mailTimout=function(){rcs_mobile.fixMessageList();rcs_mobile.setMailTimeout()};this.fixMessageList=function(){var c=$("#messagelist tr.message:first");if(!c.length||c.hasClass("processed")){return}c.addClass("processed");var a=$("#aria-label-messagelist").length;$("#messagelist tr.message").each(function(){if(a){var g=$(this).attr("id");var f=rcmail.message_list.list.rows[g].uid;rcmail.message_list.list.rows[g].onmousedown=null;rcmail.message_list.list.rows[g].onmouseup=null;$(this).removeAttr("onmouseup").removeAttr("onmousedown").unbind();rcmail.message_list.list.rows[g].onclick=function(h){rcmail.message_list.select_row(f,CONTROL_KEY,true)};rcs_mobile.setupGestureMessageActions(g)}else{var f=$(this).attr("id").substr(6);$(this).removeAttr("onmouseup").removeAttr("onmousedown").unbind().click(function(){rcmail.message_list.select_row(f,CONTROL_KEY,true)})}if(!$(this).find(".subject a").length){var e=$(this).find(".subject");e.hide();e.html(e.html().replace("</span>","</span><a href='./?_task=mail&_action=show&_mbox="+rcmail.env.mailbox+"&_uid="+f+"'>")+"</a>");e.show()}if($(this).find(".fromto").length){$(this).find(".from").remove();$(this).find(".to").remove()}else{if($(this).find(".from").length){$(this).find(".to").remove()}}});$("#messagelist .subject a").removeAttr("onclick");$("#messagelist .subject a").removeAttr("onmouseover");$("#messagelist .subject a").on("click",function(f){f.stopPropagation()});var b=rcmail.env.search_mods[rcmail.env.mailbox]?rcmail.env.search_mods[rcmail.env.mailbox]:rcmail.env.search_mods["*"];for(var d in b){$("#s_mod_"+d).attr("checked",true)}$("#messagelistcontainer").append($("#countcontrols"))};this.updateFunnel=function(){$("#button-funnel").toggleClass("active",this.searchActive||this.filterActive);$(".funnel-filter").toggleClass("active",this.filterActive);$(".funnel-search").toggleClass("active",this.searchActive);if(this.searchActive||this.filterActive){this.blink($("#button-funnel span"))}};this.applySearch=function(b,a){this.searchActive=true;rcmail.command("search","",a);rcs_mobile.updateFunnel(true);rcs_mobile.popupHide(b)};this.resetSearch=function(b,a){this.searchActive=false;rcmail.command("reset-search","",a,b);rcs_mobile.updateFunnel();rcs_mobile.popupHide(b)};this.applyFilter=function(a,b){this.filterActive=b!="ALL";rcmail.filter_mailbox(b);rcs_mobile.updateFunnel();rcs_mobile.popupHide(a)};this.blink=function(a){a.fadeOut("slow",function(){a.fadeIn("slow",function(){a.fadeOut("slow",function(){a.fadeIn("slow")})})})};this.updateCurrentFolder=function(){$("#current-folder span").html($("#mailboxcontainer li.selected a").html())};this.showCalendarOld=function(a){if(a=="sections"){$("#calendar-header").hide();$("#todaybutton").css("visibility","hidden");$("#prefs-box").css("visibility","hidden");$("#calendar").css("visibility","hidden");$("#tasks").css("visibility","hidden");$("#sectionslist").css("visibility","visible");$(".calendar-page #mainscreen").css("top",50);$("#main-menu #button-sections").addClass("active");$("#main-menu #button-calendar").removeClass("active");$("#main-menu #button-tasks").removeClass("active")}else{if(a=="calendar"){$("#calendar-header").show();$("#todaybutton").css("visibility","visible");$("#sectionslist").css("visibility","hidden");$("#prefs-box").css("visibility","visible");$("#tasks").css("visibility","hidden");$("#calendar").css("visibility","visible");$(".calendar-page #mainscreen").css("top",110);$("#main-menu #button-sections").removeClass("active");$("#main-menu #button-calendar").addClass("active");$("#main-menu #button-tasks").removeClass("active")}else{if(a=="tasks"){$("#calendar-header").hide();$("#todaybutton").css("visibility","hidden");$("#sectionslist").css("visibility","hidden");$("#prefs-box").css("visibility","visible");$("#calendar").css("visibility","hidden");$("#tasks").css("visibility","visible");$(".calendar-page #mainscreen").css("top",50);$("#main-menu #button-sections").removeClass("active");$("#main-menu #button-calendar").removeClass("active");$("#main-menu #button-tasks").addClass("active")}}}};this.showCalendar=function(a){if(a=="sections"){$("#calendar").css("visibility","hidden");$("#calendarsidebar").css("visibility","visible");$("#main-menu #button-sections").addClass("active");$("#main-menu #button-calendar").removeClass("active")}else{if(a=="calendar"){$("#calendar").css("visibility","visible");$("#calendarsidebar").css("visibility","hidden");$("#main-menu #button-sections").removeClass("active");$("#main-menu #button-calendar").addClass("active")}}};this.showTasks=function(a){if(a=="sections"){$(".tasklistview #sidebar").css("visibility","visible");$(".tasklistview #mainview-right").css("visibility","hidden");$("#main-menu #button-sections").addClass("active");$("#main-menu #button-tasks").removeClass("active")}else{if(a=="tasks"){$(".tasklistview #sidebar").css("visibility","hidden");$(".tasklistview #mainview-right").css("visibility","visible");$("#main-menu #button-sections").removeClass("active");$("#main-menu #button-tasks").addClass("active")}}};this.toggleCC=function(b){var a=$("#compose-"+b).attr("style");if(typeof a=="undefined"||a=="display: none;"){UI.show_header_row(b)}else{UI.hide_header_row(b)}};this.setupGestureRefresh=function(){if(!$("#messagelist").length||!$("#mainscreencontent").length){return}var b=50;var d=$("#mainscreencontent");var c=$("#mainscreen");var a=$("#messagelistcontainer");var e=new Hammer(document.getElementById("mainscreencontent"));e.on("hammer.input",function(g){if(g.direction!=Hammer.DIRECTION_NONE&&g.direction!=Hammer.DIRECTION_UP&&g.direction!=Hammer.DIRECTION_DOWN){return}var h=g.deltaY;if(h>b){h=b}if(h<0){h=0}if(g.isFirst){if(!a.scrollTop()){rcs_mobile.panRefreshAllowed=true}return}if(g.isFinal){if(!rcs_mobile.panRefreshAllowed){return}var f=function(){d.css("top",0).removeClass("gesture-refresh");c.removeClass("refresh").removeClass("ready");a.css("overflow-y","auto");$(window).unbind("touchmove");rcs_mobile.panRefreshAllowed=false};if(h>=b){rcmail.command("checkmail","",this,g);setTimeout(f,400)}else{setTimeout(f,0)}return}if(g.direction==Hammer.DIRECTION_DOWN){if(!rcs_mobile.panRefreshAllowed){return}$(window).bind("touchmove",function(i){i.preventDefault()});c.addClass("refresh");if(h==b){c.addClass("ready")}a.css("overflow-y","hidden");d.addClass("gesture-refresh");d.css("top",h);return}if(g.direction==Hammer.DIRECTION_UP){if(!rcs_mobile.panRefreshAllowed){return}d.css("top",h);if(h<b){c.removeClass("ready")}return}})};this.setupGestureMessageView=function(){if(!$("#messagecontent").length){return}var c=70;var d=$("#mainscreencontent");var e=$("#messageheader");var b=$("#mailview-right");var a=$("#mainscreen");e.hammer({direction:Hammer.DIRECTION_HORIZONTAL,threshold:10}).bind("pan",function(g){if(g.gesture.offsetDirection==Hammer.DIRECTION_LEFT){var h="prev"}else{if(g.gesture.offsetDirection==Hammer.DIRECTION_RIGHT){var h="next"}else{return}}var f=(h=="prev"&&$(".prevpage").hasClass("disabled"))||(h=="next"&&$(".nextpage").hasClass("disabled"));b.addClass("gesture-pan");var i=g.gesture.deltaX;if(i>c){i=c}if(i<c*-1){i=c*-1}if(g.gesture.isFinal){if(!f&&Math.abs(i)==c){d.fadeOut(200,function(){a.addClass("progress");setTimeout(function(){rcmail.command(h=="prev"?"previousmessage":"nextmessage","",this,"click")},100)});return}e.css("left",0);e.css("right",0);b.removeClass("gesture-pan");return}if(h=="prev"){b.removeClass("next")}else{b.removeClass("prev")}b.addClass(h);if(f){b.addClass("disabled")}else{b.removeClass("disabled");if(Math.abs(i)==c){b.addClass("ready")}else{b.removeClass("ready")}}e.css("left",i);e.css("right",i*-1)})};this.selectMessage=function(a,b){rcmail.message_list.select_row(rcmail.message_list.list.rows[b].uid,"",true)};this.deleteMessage=function(a,b){rcs_mobile.selectMessage(a,b);rcmail.command("delete","",this,a);rcmail.message_list.clear_selection();$("#mal-"+b).hide()};this.flagMessage=function(a,b){this.selectMessage(a,b);rcmail.command("mark","flagged",this,a);rcmail.message_list.clear_selection();$("#mal-"+b).addClass("flagged");this.hideMessageActions(b)};this.unflagMessage=function(a,b){this.selectMessage(a,b);rcmail.command("mark","unflagged",this,a);rcmail.message_list.clear_selection();$("#mal-"+b).removeClass("flagged");this.hideMessageActions(b)};this.showMoreOnMessage=function(a,b){this.selectMessage(a,b);this.clearSelectionOnPopupHide=true;this.hideMessageActions(b);rcs_mobile.popup(a,"messagetoolbar")};this.hideMessageActions=function(a){$("#"+a).animate({width:$("#messagelist").width()},300)};this.setupGestureMessageActions=function(c){var d=$("#"+c);var b=180;var a=$("<div class='message-action-links'><a class='mal-more' href='javascript:void(0)' onclick='rcs_mobile.showMoreOnMessage(event, \""+c+"\")'></a><a class='mal-flag' href='javascript:void(0)' onclick='rcs_mobile.flagMessage(event, \""+c+"\")'></a><a class='mal-unflag' href='javascript:void(0)' onclick='rcs_mobile.unflagMessage(event, \""+c+"\")'></a><a class='mal-delete' href='javascript:void(0)' onclick='rcs_mobile.deleteMessage(event, \""+c+"\")'></a></div>").attr("id","mal-"+c);if(d.hasClass("flagged")){a.addClass("flagged")}d.before(a);d.hammer({direction:Hammer.DIRECTION_HORIZONTAL,threshold:30}).bind("pan",function(e){if(e.gesture.offsetDirection==Hammer.DIRECTION_LEFT){var f="right"}else{if(e.gesture.offsetDirection==Hammer.DIRECTION_RIGHT){var f="left"}else{return}}if(!rcs_mobile.panDirection){rcs_mobile.panDirection=f}var g=$("#messagelist").width();var h=e.gesture.deltaX;if(rcs_mobile.panDirection=="left"&&h<b*-1){h=b*-1}if(rcs_mobile.panDirection=="right"&&h>b){h=b}if((rcs_mobile.panDirection=="left"&&h>0)||(rcs_mobile.panDirection=="right"&&h<0)){h=0}if(e.gesture.isFinal){if(f=="left"){if(d.width()<g-b*0.3){if(rcs_mobile.actionRowOpen&&rcs_mobile.actionRowOpen!=c){rcs_mobile.hideMessageActions(rcs_mobile.actionRowOpen)}rcs_mobile.actionRowOpen=c;d.animate({width:g-b},100)}else{d.animate({width:g},100,"swing",function(){d.css("width","100%")});$("#mal-"+c).hide()}}else{if(d.width()>g-b*0.7){d.animate({width:g},100,"swing",function(){d.css("width","100%")});rcs_mobile.actionRowOpen=false;$("#mal-"+c).hide()}else{d.animate({width:g-b},100)}}rcs_mobile.panDirection=false;return}$("#mal-"+c).show();if(rcs_mobile.panDirection=="left"){if(d.width()>g-b){d.width(g+h)}}else{if(d.width()<g){d.width(g-b+h)}}})};this.log=function(a){if(this.debug){console.log(a)}}};function settingsLoader(a){this.value=a;this.get_single_selection=function(){return this.value}};